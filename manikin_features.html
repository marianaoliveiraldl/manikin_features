
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manikin Feature Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --yes:#c8e6c9; --no:#ffcdd2; --border:#ddd; --bg:#f6f6f6; --warn:#fff8e1; --warn-border:#ffecb3; --active:#0b5ed7; --activeText:#fff; }
    body { font-family: Arial, sans-serif; margin: 24px; }
    h2 { margin-top: 0; }
    .controls { display: grid; grid-template-columns: 1fr auto auto auto; gap: 12px; align-items: center; }
    .controls input[type="text"], .controls select, .controls button { padding: 8px; font-size: 14px; }
    .views { display: flex; gap: 8px; }
    .views button { border: 1px solid #ccc; background: #fff; cursor: pointer; border-radius: 4px; }
    .views button.active { background: var(--active); color: var(--activeText); border-color: var(--active); }
    .toggle { display: flex; gap: 8px; align-items: center; }
    .subcontrols { display: flex; gap: 8px; align-items: center; }
    table { border-collapse: collapse; width: 100%; margin-top: 16px; }
    th, td { border: 1px solid var(--border); padding: 6px 8px; text-align: left; white-space: nowrap; }
    th { background: var(--bg); position: sticky; top: 0; z-index: 1; }
    .yes { background-color: var(--yes); }
    .no  { background-color: var(--no); }
    .hidden { display: none; }
    .footer { margin-top: 16px; font-size: 12px; color: #666; }
    .warn { background: var(--warn); border: 1px solid var(--warn-border); padding: 10px 12px; margin-bottom: 12px; }
    @media (max-width: 900px) {
      table { font-size: 13px; }
      .controls { grid-template-columns: 1fr; }
    }
    /* Start hidden; JS shows it in Feature view */
    #hideXWrap { display: none; }
  </style>
</head>
<body>
  <h2>Manikin Feature Finder</h2>

  <div id="banner" class="warn hidden">
    ‚ö†Ô∏è Couldn‚Äôt build the data model. Open DevTools (F12) ‚Üí Console for details.
  </div>

  <div class="controls">
    <!-- Search -->
    <input id="searchInput" type="text" placeholder="Search (Feature/Manikin)..." />

    <!-- View buttons -->
    <div class="views">
      <button id="btnComplete" aria-pressed="true" class="active">Complete view</button>
      <button id="btnFeature" aria-pressed="false">Feature view</button>
      <button id="btnManikin" aria-pressed="false">Manikin view</button>
    </div>

    <!-- Hide X toggle (visible only in Feature view) -->
    <label class="toggle" id="hideXWrap">
      <input type="checkbox" id="hideX" />
      <span>Hide unsupported (X)</span>
    </label>

    <!-- Per-view selectors -->
    <div class="subcontrols">
      <label for="featureSelect">Feature:</label>
      <select id="featureSelect"></select>

      <label for="manikinSelect">Manikin:</label>
      <select id="manikinSelect"></select>
    </div>
  </div>

  <table id="resultsTable"></table>

  <!-- Early global error catcher & boot logs -->
  <script>
    window.addEventListener('error', function (e) {
      console.log('Global error:', e.message, e.filename, e.lineno, e.colno);
      const banner = document.getElementById('banner');
      banner.classList.remove('hidden');
      banner.textContent = '‚ö†Ô∏è Script error: ' + e.message;
    });
    console.log('üîé mapping.html loaded');
  </script>

  <!-- Embedded CSV: uses \u2713 instead of literal ‚úì for safe encoding -->
  <script>
    const TICK = '\u2713';
    const csv = `"Feature","SimMan 3G Plus","SimMan 3G","SimMan 3G Trauma","SimMan 3G Mystic","SimMan Essential","SimMan Essential Bleeding","SimMan ALS","Mama Anne","SimMom","Nursing Anne Simulator","SimBaby","SimJunior","SimNewb"
"Fluids","${TICK} FluidsControl.xaml","X","X","X","X","X","X","X","X","X","X","X","X"
"Circulation","X","X","X","X","${TICK} Circulation_Fluids.xaml","X","${TICK} Circulation_Fluids.xaml","X","${TICK} BleedingView.xaml","${TICK} Circulation_Fluids.xaml","X","X","X"
"Circulation & Bleeding","${TICK} Circulation_Bleeding.xaml","X","X","X","X","X","X","${TICK} BleedingView.xaml","X","X","X","X","X"
"Circulation & Fluids","X","${TICK} Circulation_Fluids.xaml","${TICK} Circulation_Fluids.xaml","${TICK} Circulation_Fluids.xaml","X","${TICK} Circulation_Fluids.xaml","X","X","X","X","X","X","X"
"Circulation & Motions","X","X","X","X","X","X","X","X","X","X","${TICK} Circulation_Fluids.xaml","${TICK} Circulation_Fluids.xaml","${TICK} Circulation_Fluids.xaml"
"Convulsions","${TICK} ConvulsionsControl.xaml","X","X","X","X","X","X","${TICK} ConvulsionsControl.xaml","${TICK} ConvulsionsControl.xaml","X","X","X","X"
"EFM","X","X","X","X","X","X","X","${TICK} CtgInstructorMonitor_View.xaml","${TICK} CtgInstructorMonitor_View.xaml","X","X","X","X"
"EFM Options","X","X","X","X","X","X","X","${TICK} CtgOptionsView.xaml","${TICK} CtgOptionsView.xaml","X","X","X","X"
"Delivery","X","X","X","X","X","X","X","${TICK} Obstetrics_View.xaml","${TICK} Obstetrics_View.xaml","X","X","X","X"
"CPR","${TICK} QCPRLiveView.xaml","${TICK} QCPRLiveView.xaml","${TICK} QCPRLiveView.xaml","${TICK} QCPRLiveView.xaml","${TICK} QCPRLiveView.xaml","${TICK} QCPRLiveView.xaml","${TICK} QCPRLiveView.xaml","${TICK} QCPRLiveView.xaml","X","X","${TICK} QCPRLiveView.xaml","X","X"
"CPR History","${TICK} QCPRHistoryView.xaml","${TICK} QCPRHistoryView.xaml","${TICK} QCPRHistoryView.xaml","${TICK} QCPRHistoryView.xaml","${TICK} QCPRHistoryView.xaml","${TICK} QCPRHistoryView.xaml","${TICK} QCPRHistoryView.xaml","${TICK} QCPRHistoryView.xaml","X","X","${TICK} QCPRHistoryView.xaml","X","X"
"Airway & Breathing","${TICK} AirwayBreathing.xaml","${TICK} AirwayBreathing.xaml","${TICK} AirwayBreathing.xaml","${TICK} AirwayBreathing.xaml","${TICK} AirwayBreathing.xaml","${TICK} AirwayBreathing.xaml","${TICK} AirwayBreathing.xaml","${TICK} AirwayBreathing.xaml","${TICK} AirwayBreathing.xaml","${TICK} AirwayBreathing.xaml","${TICK} AirwayBreathing.xaml","${TICK} AirwayBreathing.xaml","${TICK} AirwayBreathing.xaml"
"Events","${TICK} EventsView_View.xaml","${TICK} EventsView_View.xaml","${TICK} EventsView_View.xaml","${TICK} EventsView_View.xaml","${TICK} EventsView_View.xaml","${TICK} EventsView_View.xaml","${TICK} EventsView_View.xaml","${TICK} EventsView_View.xaml","${TICK} EventsView_View.xaml","${TICK} EventsView_View.xaml","${TICK} EventsView_View.xaml","${TICK} EventsView_View.xaml","${TICK} EventsView_View.xaml"
"Eyes","${TICK} EyeControl.cs","${TICK} EyeControl.cs","${TICK} EyeControl.cs","${TICK} EyeControl.cs","${TICK} EyeControl.cs","${TICK} EyeControl.cs","${TICK} EyeControl.cs","${TICK} EyeControl.cs","${TICK} EyeControl.cs","${TICK} EyeControl.cs","${TICK} EyeControl.cs","${TICK} EyeControl.cs","${TICK} EyeControl.cs"
"Ongoing Care","${TICK} StateView.xaml","${TICK} StateView.xaml","${TICK} StateView.xaml","${TICK} StateView.xaml","${TICK} StateView.xaml","${TICK} StateView.xaml","${TICK} StateView.xaml","${TICK} StateView.xaml","${TICK} StateView.xaml","${TICK} StateView.xaml","${TICK} StateView.xaml","${TICK} StateView.xaml","${TICK} StateView.xaml"
"Patient Monitor","${TICK} PatientMonitorLayout.cpp","${TICK} PatientMonitorLayout.cpp","${TICK} PatientMonitorLayout.cpp","${TICK} PatientMonitorLayout.cpp","${TICK} PatientMonitorLayout.cpp","${TICK} PatientMonitorLayout.cpp","${TICK} PatientMonitorLayout.cpp","${TICK} PatientMonitorLayout.cpp","${TICK} PatientMonitorLayout.cpp","${TICK} PatientMonitorLayout.cpp","${TICK} PatientMonitorLayout.cpp","${TICK} PatientMonitorLayout.cpp","${TICK} PatientMonitorLayout.cpp"
"Session Control","${TICK} SessionControl.xaml","${TICK} SessionControl.xaml","${TICK} SessionControl.xaml","${TICK} SessionControl.xaml","${TICK} SessionControl.xaml","${TICK} SessionControl.xaml","${TICK} SessionControl.xaml","${TICK} SessionControl.xaml","${TICK} SessionControl.xaml","${TICK} SessionControl.xaml","${TICK} SessionControl.xaml","${TICK} SessionControl.xaml","${TICK} SessionControl.xaml"
"Sounds","${TICK} SoundControl.cs","${TICK} SoundControl.cs","${TICK} SoundControl.cs","${TICK} SoundControl.cs","${TICK} SoundControl.cs","${TICK} SoundControl.cs","${TICK} SoundControl.cs","${TICK} SoundControl.cs","${TICK} SoundControl.cs","${TICK} SoundControl.cs","${TICK} SoundControl.cs","${TICK} SoundControl.cs","${TICK} SoundControl.cs"
"Status Bar","${TICK} StatusBar.xaml","${TICK} StatusBar.xaml","${TICK} StatusBar.xaml","${TICK} StatusBar.xaml","${TICK} StatusBar.xaml","${TICK} StatusBar.xaml","${TICK} StatusBar.xaml","${TICK} StatusBar.xaml","${TICK} StatusBar.xaml","${TICK} StatusBar.xaml","${TICK} StatusBar.xaml","${TICK} StatusBar.xaml","${TICK} StatusBar.xaml"
"Theme Control","${TICK} StatesView_View.xaml","${TICK} StatesView_View.xaml","${TICK} StatesView_View.xaml","${TICK} StatesView_View.xaml","${TICK} StatesView_View.xaml","${TICK} StatesView_View.xaml","${TICK} StatesView_View.xaml","${TICK} StatesView_View.xaml","${TICK} StatesView_View.xaml","${TICK} StatesView_View.xaml","${TICK} StatesView_View.xaml","${TICK} StatesView_View.xaml","${TICK} StatesView_View.xaml"
"Session Log","${TICK} LogView.xaml","${TICK} LogView.xaml","${TICK} LogView.xaml","${TICK} LogView.xaml","${TICK} LogView.xaml","${TICK} LogView.xaml","${TICK} LogView.xaml","${TICK} LogView.xaml","${TICK} LogView.xaml","${TICK} LogView.xaml","${TICK} LogView.xaml","${TICK} LogView.xaml","${TICK} LogView.xaml"
"Simulator","${TICK} ManikinStatus.xaml","${TICK} ManikinStatus.xaml","${TICK} ManikinStatus.xaml","${TICK} ManikinStatus.xaml","${TICK} ManikinStatus.xaml","${TICK} ManikinStatus.xaml","${TICK} ManikinStatus.xaml","${TICK} ManikinStatus.xaml","${TICK} ManikinStatus.xaml","${TICK} ManikinStatus.xaml","${TICK} ManikinStatus.xaml","${TICK} ManikinStatus.xaml","${TICK} ManikinStatus.xaml"
"Local PC Status","${TICK} LocalPCStatus.xaml","${TICK} LocalPCStatus.xaml","${TICK} LocalPCStatus.xaml","${TICK} LocalPCStatus.xaml","${TICK} LocalPCStatus.xaml","${TICK} LocalPCStatus.xaml","${TICK} LocalPCStatus.xaml","${TICK} LocalPCStatus.xaml","${TICK} LocalPCStatus.xaml","${TICK} LocalPCStatus.xaml","${TICK} LocalPCStatus.xaml","${TICK} LocalPCStatus.xaml","${TICK} LocalPCStatus.xaml"
"Connections Status","${TICK} ConnectionStatus.xaml","${TICK} ConnectionStatus.xaml","${TICK} ConnectionStatus.xaml","${TICK} ConnectionStatus.xaml","${TICK} ConnectionStatus.xaml","${TICK} ConnectionStatus.xaml","${TICK} ConnectionStatus.xaml","${TICK} ConnectionStatus.xaml","${TICK} ConnectionStatus.xaml","${TICK} ConnectionStatus.xaml","${TICK} ConnectionStatus.xaml","${TICK} ConnectionStatus.xaml","${TICK} ConnectionStatus.xaml"
"Prediction","${TICK} ParameterPredictionWindow.cpp","${TICK} ParameterPredictionWindow.cpp","${TICK} ParameterPredictionWindow.cpp","${TICK} ParameterPredictionWindow.cpp","${TICK} ParameterPredictionWindow.cpp","${TICK} ParameterPredictionWindow.cpp","${TICK} ParameterPredictionWindow.cpp","${TICK} ParameterPredictionWindow.cpp","${TICK} ParameterPredictionWindow.cpp","${TICK} ParameterPredictionWindow.cpp","${TICK} ParameterPredictionWindow.cpp","${TICK} ParameterPredictionWindow.cpp","${TICK} ParameterPredictionWindow.cpp"
"Trends","${TICK} TTrendHandlerControllerGUI.cs","${TICK} TTrendHandlerControllerGUI.cs","${TICK} TTrendHandlerControllerGUI.cs","${TICK} TTrendHandlerControllerGUI.cs","${TICK} TTrendHandlerControllerGUI.cs","${TICK} TTrendHandlerControllerGUI.cs","${TICK} TTrendHandlerControllerGUI.cs","${TICK} TTrendHandlerControllerGUI.cs","${TICK} TTrendHandlerControllerGUI.cs","${TICK} TTrendHandlerControllerGUI.cs","${TICK} TTrendHandlerControllerGUI.cs","${TICK} TTrendHandlerControllerGUI.cs","${TICK} TTrendHandlerControllerGUI.cs"
"Cardiac","${TICK} heartRhythmController.cs","${TICK} heartRhythmController.cs","${TICK} heartRhythmController.cs","${TICK} heartRhythmController.cs","${TICK} heartRhythmController.cs","${TICK} heartRhythmController.cs","${TICK} heartRhythmController.cs","${TICK} heartRhythmController.cs","${TICK} heartRhythmController.cs","${TICK} heartRhythmController.cs","${TICK} heartRhythmController.cs","${TICK} heartRhythmController.cs","${TICK} heartRhythmController.cs"
"Comments","${TICK} CommentControl.cs","${TICK} CommentControl.cs","${TICK} CommentControl.cs","${TICK} CommentControl.cs","${TICK} CommentControl.cs","${TICK} CommentControl.cs","${TICK} CommentControl.cs","${TICK} CommentControl.cs","${TICK} CommentControl.cs","${TICK} CommentControl.cs","${TICK} CommentControl.cs","${TICK} CommentControl.cs","${TICK} CommentControl.cs"
"Learner Patient Monitor Buttons","${TICK} MonitorButtonsController.cs","${TICK} MonitorButtonsController.cs","${TICK} MonitorButtonsController.cs","${TICK} MonitorButtonsController.cs","${TICK} MonitorButtonsController.cs","${TICK} MonitorButtonsController.cs","${TICK} MonitorButtonsController.cs","${TICK} MonitorButtonsController.cs","${TICK} MonitorButtonsController.cs","${TICK} MonitorButtonsController.cs","${TICK} MonitorButtonsController.cs","${TICK} MonitorButtonsController.cs","${TICK} MonitorButtonsController.cs"`;
  </script>

  <!-- Main logic -->
  <script>
    function parseCSV(text) {
      // Trim leading/trailing blank lines to avoid empty header
      const lines = text.split(/\r?\n/).map(l => l.trim());
      // Remove any empty lines at the start/end
      while (lines.length && !lines[0]) lines.shift();
      while (lines.length && !lines[lines.length-1]) lines.pop();
      const rows = lines.map(line => {
        const cells = []; let i = 0, inQuotes = false, cell = '';
        while (i < line.length) {
          const ch = line[i];
          if (ch === '"') {
            if (inQuotes && line[i+1] === '"') { cell += '"'; i += 2; }
            else { inQuotes = !inQuotes; i++; }
          } else if (ch === ',' && !inQuotes) { cells.push(cell); cell = ''; i++; }
          else { cell += ch; i++; }
        }
        cells.push(cell);
        return cells.map(c => c.trim());
      });
      return rows;
    }

    function buildModel(rows) {
      if (!rows || rows.length < 2) return null;
      const header = rows[0];
      const manikins = header.slice(1);
      const dataByFeature = {};
      const dataByManikin = {};
      manikins.forEach(m => dataByManikin[m] = {});
      for (let r = 1; r < rows.length; r++) {
        const feature = rows[r][0]; if (!feature) continue;
        dataByFeature[feature] = {};
        for (let c = 1; c < header.length; c++) {
          const m = header[c], raw = (rows[r][c] || '').trim();
          const v = (raw.startsWith('\u2713') || raw.startsWith('‚úì')) ? '‚úì' : 'X';
          dataByFeature[feature][m] = v;
          dataByManikin[m][feature] = v;
        }
      }
      return { features: Object.keys(dataByFeature), manikins, dataByFeature, dataByManikin };
    }

    function renderComplete(el, model, term = '', hideX = false) {
      const t = term.toLowerCase();
      const fRows = model.features.filter(f => !t || f.toLowerCase().includes(t));
      const mCols = model.manikins.filter(m => !t || m.toLowerCase().includes(t));
      let html = '<tr><th>Feature \\ Manikin</th>';
      mCols.forEach(m => html += `<th>${m}</th>`); html += '</tr>';
      fRows.forEach(f => {
        html += `<tr><th>${f}</th>`;
        mCols.forEach(m => {
          const v = model.dataByFeature[f][m];
          if (hideX && v !== '‚úì') html += `<td class="hidden"></td>`;
          else html += `<td class="${v==='‚úì'?'yes':'no'}">${v}</td>`;
        });
        html += `</tr>`;
      });
      el.innerHTML = html;
    }

    function renderFeature(el, f, model, term = '', hideX = false) {
      const t = term.toLowerCase(); el.innerHTML = `<tr><th>Manikin</th><th>${f}</th></tr>`;
      const row = model.dataByFeature[f];
      Object.keys(row).forEach(m => {
        const v = row[m];
        if (hideX && v !== '‚úì') return;
        if (t && !m.toLowerCase().includes(t)) return;
        el.innerHTML += `<tr><td>${m}</td><td class="${v==='‚úì'?'yes':'no'}">${v}</td></tr>`;
      });
    }

    function renderManikin(el, m, model, term = '', hideX = false) {
      const t = term.toLowerCase(); el.innerHTML = `<tr><th>Feature</th><th>${m}</th></tr>`;
      const row = model.dataByManikin[m];
      Object.keys(row).forEach(f => {
        const v = row[f];
        if (hideX && v !== '‚úì') return;
        if (t && !f.toLowerCase().includes(t)) return;
        el.innerHTML += `<tr><td>${f}</td><td class="${v==='‚úì'?'yes':'no'}">${v}</td></tr>`;
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ DOMContentLoaded');
      const rows = parseCSV(csv);
      console.log('üìä Parsed rows:', rows.length);
      const model = buildModel(rows);
      if (!model || !model.features.length || !model.manikins.length) {
        document.getElementById('banner').classList.remove('hidden');
        console.log('‚ùå Model build failed', { rows, model });
        return;
      }
      console.log('‚úÖ Features:', model.features.length, 'Manikins:', model.manikins.length);

      const featureSelect = document.getElementById('featureSelect');
      const manikinSelect = document.getElementById('manikinSelect');
      const table = document.getElementById('resultsTable');
      const searchInput = document.getElementById('searchInput');
      const hideXWrap = document.getElementById('hideXWrap');
      const hideX = document.getElementById('hideX');
      const btnComplete = document.getElementById('btnComplete');
      const btnFeature = document.getElementById('btnFeature');
      const btnManikin = document.getElementById('btnManikin');

      // Populate selects (ensure they are never empty)
      featureSelect.innerHTML = '';
      model.features.forEach(f => featureSelect.appendChild(new Option(f, f)));
      manikinSelect.innerHTML = '';
      model.manikins.forEach(m => manikinSelect.appendChild(new Option(m, m)));
      if (!featureSelect.value && featureSelect.options.length) featureSelect.value = featureSelect.options[0].value;
      if (!manikinSelect.value && manikinSelect.options.length) manikinSelect.value = manikinSelect.options[0].value;

      // View state
      let view = 'complete'; // default
      function setActive(btn) {
        [btnComplete, btnFeature, btnManikin].forEach(b => {
          const active = (b === btn);
          b.classList.toggle('active', active);
          b.setAttribute('aria-pressed', active ? 'true' : 'false');
        });
      }
      function render() {
        const term = searchInput.value.trim();
        const hx = hideX.checked;

        // Show Hide-X only in Feature view
        hideXWrap.style.display = (view === 'feature') ? 'flex' : 'none';

        if (view === 'complete') {
          renderComplete(table, model, term, /*hideX*/ false);
          setActive(btnComplete);
        } else if (view === 'feature') {
          const f = featureSelect.value || model.features[0];
          renderFeature(table, f, model, term, hx);
          setActive(btnFeature);
        } else {
          const m = manikinSelect.value || model.manikins[0];
          renderManikin(table, m, model, term, /*hideX*/ false);
          setActive(btnManikin);
        }
      }

      // Initial render
      render();

      // Events
      featureSelect.addEventListener('change', render);
      manikinSelect.addEventListener('change', render);
      hideX.addEventListener('change', render);
      searchInput.addEventListener('input', () => render());
      btnComplete.addEventListener('click', () => { view = 'complete'; render(); });
      btnFeature.addEventListener('click',  () => { view = 'feature';  render(); });
      btnManikin.addEventListener('click',  () => { view = 'manikin';  render(); });
    });
  </script>

  <div class="footer">
    Tip: ‚ÄúComplete view‚Äù shows the full matrix. ‚ÄúFeature view‚Äù lets you hide unsupported (X). Active view is highlighted.
  </div>
</body>
</html>
